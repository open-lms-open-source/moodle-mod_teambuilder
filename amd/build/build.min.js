define(["jquery","jqueryui","core/str"],function(b,d,e){var f,g=85,h=1,l=2,m=[],n=[],o=[],p=0,r={},u="",v="",w="",y=function(a){r.any=a[0],r.all=a[1],r.none=a[2],r.or=a[3],r.and=a[4],r.addnewsubcriterion=a[5],r.criterionquestion=a[6],r.criterionsubquestion=a[7],u='<option value="any">'+r.any+"</option>",u+='<option value="all">'+r.all+"</option>",u+='<option value="none">'+r.none+"</option>";var b='<select class="questions"></select>';v='<div class="criterionWrapper"><div class="criterion ui-corner-all">',v+='<div class="criterionDelete"></div>',v+=r.criterionquestion.replace("{question}",b).replace("{options}",'<select class="oper">'+u+"</select>"),v+='<div class="answers"></div>',v+='<div class="add_sub">',v+='<a href="#" class="addsubcriterion" title="'+r.addnewsubcriterion+'"><img src="css/add_sub.png" /></a>',v+="</div>",v+='<div class="subcriteria"></div>',v+='<div class="runningCounter"></div>',v+='</div><div class="boolOper">'+r.and+"</div></div>",w='<div class="subcriterionWrapper"><div class="criterionDelete"></div>',w+=r.criterionsubquestion.replace("{question}",b).replace("{options}",'<select class="oper">'+u+"</select>"),w+='<div class="answers"></div></div>'},z=function(){b(".stepper").each(function(){var a=b(this).html(),c="<span><div class='ui-stepper-down'></div><span>",d="</span><div class='ui-stepper-up'></div></span>",e=b(c+a+d);e.find(".ui-stepper-up").click(function(){var a=parseInt(e.find("span").html());a++,e.find("span").html(a),A(a)}),e.find(".ui-stepper-down").click(function(){var a=parseInt(e.find("span").html());a--,a<1&&(a=1),e.find("span").html(a),A(a)}),b(this).empty(),b(this).append(e)}),b(".student").each(function(){b(this).width()>g&&(g=b(this).width())}),b(".student").each(function(){b(this).width(g)}),b("#unassigned, #teams").on("mouseup",".student",function(c){if(p)return void(p=!1);var d=b('<div class="studentResponse ui-corner-all"></div>'),e=/student-(\d+)/.exec(b(this).attr("id")),f=responses[e[1]];if(f){var g=b("<table></table>");d.append(g);for(i in questions){q=questions[i],qr=[];// Question responses.
for(j in q.answers)a=q.answers[j],b.inArray(parseInt(a.id),f)!=-1&&qr.push(a.answer);var h=b('<tr><th scope="row">'+q.question+"</th><td>"+qr.join("<br/>")+"</td></tr>");g.append(h)}}else d.html("This student has not responded.");b(document.body).append(d),d.css("left",c.pageX),d.css("top",c.pageY);var k=function(a){a.target!=d.get(0)&&(d.remove(),b(document).unbind("mousedown",k))};b(document).mousedown(k);var l,m=function(a){stresponse=b(a.target).closest(".studentResponse"),a.target!=this&&(0==stresponse.length||stresponse.length>0&&d.get(0)!=stresponse.get(0))?void 0==l&&(l=setTimeout(function(){d.remove()},500)):l&&clearTimeout(l)};b(document).mouseover(m)}),b("#teams").on("dblclick",".team > h2",function(a){function c(){var a=b("<h2>"+f.val()+"</h2>");a.width(f.width()),a.height(f.height()),f.replaceWith(a),n[a.parent().index()]=a.html()}var d=b(a.target),e=d.html(),f=b('<input type="text" value="'+e+'" />');f.css("font-size",d.css("font-size")),f.width(d.width()),f.height(d.height()),f.css("border-width","0px");
// Conditionally attach the textBoxDone event if you click outside the textbox.
var g=function(a){a.target!=f.get(0)&&(c(),b(document).unbind("mousedown",g))};b(document).mousedown(g),
// If you press return.
f.keypress(function(a){13==a.keyCode&&(c(),b(document).unbind("mousedown",g))}),d.replaceWith(f),f.focus(),f.select()}),f=b("#unassigned").html(),A(2),E()},A=function(a){
// Slice off the end of the names array if needed.
if(G(),
// Slice off the end of the teams array if needed.
m.length>a&&(m=m.slice(0,a)),n.length>a)n=n.slice(0,a);else if(n.length<a)for(i=n.length-1;i<a;i++)n[i]="Team "+(i+1);H()},B=function(){o=[];for(var a=0;a<m.length;a++)m[a]=[];H(),b("#debug").html("")},C=function(a){var b=I(a);ctr=0;for(i in students)responses[i]!==!1&&L(i,b)&&ctr++;a.find(".runningCounter").html(ctr),ctr<n.length?a.find(".runningCounter").css("color","#E9AAAA"):a.find(".runningCounter").css("color","")},D=function(c,d){q=questions[c];var e=b("<ul></ul>");for(a in q.answers)answer=q.answers[a],e.append('<li><input type="checkbox" value="'+answer.id+'">'+answer.answer+"</input></li>");d.closest(".criterionWrapper").find(".runningCounter").empty(),d.empty().append(e),d.closest(".criterionWrapper").find("ul input,select.oper").change(function(){C(b(this).closest(".criterionWrapper").children(".criterion"))})},E=function(){if(b("#predicate").length){var a=b(v);
// Insert the question data.
// Questions is defined in the document (by PHP).
for(var c in questions)q=questions[c],a.find(".questions").append('<option value="'+q.id+'">'+q.question+"</option>");
// Add our behaviours.
// Question select behaviour.
a.find(".questions").change(function(){D(this.value,b(this).nextAll(".answers:first")),"one"==questions[this.value].type?b(this).next(".oper").children("[value='all']").remove():b(this).nextAll(".oper:first").children("[value='none']").before('<option value="all">all</option>')}),a.find(".questions *:selected").change(),
// Delete button behaviours.
a.find(".criterion").hover(function(){b(this).children(".criterionDelete").fadeIn(100)},function(){b(this).children(".criterionDelete").fadeOut(100)}),a.find(".criterionDelete").click(function(){b(this).hide(),b(this).closest(".criterionWrapper").prev(".criterionWrapper").find(".boolOper").slideUp(300),b(this).closest(".criterionWrapper").slideUp(300,function(){b(this).remove()})}),
// Bool oper behaviours.
a.find(".boolOper").click(function(){var a=b(this).html();a=a==r.and?r.or:r.and,b(this).html(a)}),a.find(".boolOper").hide(),
// Show the previously hidden boolOper.
b("#predicate .boolOper").slideDown(100),b("#predicate").append(a),a.slideDown(300)}},F=function(a){var c=b(a).closest(".criterionWrapper"),d=b(w);c.find(".subcriteria").append(d);for(var e in questions)q=questions[e],d.find(".questions").append('<option value="'+q.id+'">'+q.question+"</option>");d.find(".questions").change(function(){D(this.value,b(this).nextAll(".answers:first")),"one"==questions[this.value].type?b(this).next(".oper").children("[value='all']").remove():b(this).nextAll(".oper:first").children("[value='none']").before('<option value="all">all</option>')}),d.find(".questions *:selected").change(),d.hover(function(){b(this).find(".criterionDelete").fadeIn(100)},function(){b(this).find(".criterionDelete").fadeOut(100)}),d.find(".criterionDelete").click(function(){b(this).hide(),b(this).closest(".subcriterionWrapper").slideUp(300,function(){var a=b(this).closest(".criterionWrapper").children(".criterion");b(this).remove(),C(a)})})},G=function(){
// First clear out our model.
m=[],b(".team").each(function(){var a=b(this),c=b(this).index(),d=[];a.find(".student").each(function(){var a=/student-(\d+)/.exec(b(this).attr("id"));d.push(a[1])}),m[c]=d})},H=function(){
// Reset our view.
b("#unassigned").html(f),b("#teams").empty();
// Create our team views.
for(var a=0;a<n.length;a++){var c=b('<div class="team" id="team-'+a+'" />');c.append("<h2>"+n[a]+"</h2>"),c.width(g+30),c.append('<div class="sortable"></div>'),b("#teams").append(c)}
// Get our sortable states happening.
var d={connectWith:".sortable",start:function(){p=!0}};b("#teams .sortable").sortable(d),b("#unassigned .sortable").sortable(d);
// Now to move our students to our teams.
for(a in m){var e=m[a],c=b("#team-"+a+" > div.sortable");for(j in e){var h=e[j],i=b("#student-"+h);i.detach(),c.append(i),b.inArray(h,o)!=-1?i.css("color","green"):i.css("color","")}}},I=function(a){var c={};
// Subcriteria.
return c.question=b(a).children(".questions").find("*:selected").val(),c.answers=[],c.oper=b(a).children(".oper").find("*:selected").val(),b(a).children(".answers").find("input:checked").each(function(){c.answers.push(this.value)}),c.subcriteria=[],subcriteria=b(a).children(".subcriteria"),subcriteria.find(".subcriterionWrapper").each(function(){var a={};a.question=b(this).children(".questions").find("*:selected").val(),a.answers=[],a.oper=b(this).children(".oper").find("*:selected").val(),b(this).children(".answers").find("input:checked").each(function(){a.answers.push(this.value)}),c.subcriteria.push(a)}),c},J=function(){
// This function will be comparing team indices in teamsList, so it needs to compare their priorities.
function a(a,b){return teamsPriority[a]-teamsPriority[b]}function d(a,b){return m[a].length-m[b].length}
// This function sorts like the above function, only it compares student priorities.
function e(a,b){return studentPriority[a]-studentPriority[b]}B(),G(),o=[];
// Build our predicate based on the UI.
var f=[],g=[];// Temp var for running criterion group.
b("#predicate .criterionWrapper").each(function(){var a=I(b(this).children(".criterion"));g.push(a),b(this).find(".boolOper").html()==r.and&&(f.push(g),g=[])});
// Options.
var p=b("#prioritise").val();for(unassignedStudents={},assignedStudents={},b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),unassignedStudents[rslt[1]]=students[rslt[1]]}),b(".team .student").each(function(){rslt=/student-(\d+)/.exec(this.id),assignedStudents[rslt[1]]=students[rslt[1]]}),
// Get rid of students with no responses.
b.each(responses,function(a,b){b===!1&&(delete assignedStudents[a],delete unassignedStudents[a])}),
// Initialise teamsPriority to all zeroes.
teamsPriority=[],initTeamsList=[],i=0;i<n.length;i++)teamsPriority.push(0),initTeamsList.push(i);for(i in f){O("Criterion "+i),cg=f[i],// Criterion group.
ucandidates=[],// Unassigned candidates.
acandidates=[],// Assigned candidates.
// Get candidates matching criterion group.
ucandidates=K(unassignedStudents,cg),acandidates=K(assignedStudents,cg),studentPriority={};
// Initialise studentPriority.
for(j in unassignedStudents)studentPriority[j]=0;
// This is done to optimise the selection process
// in this case priority will be an index of how much a student should NOT be selected for this criterion,
// because they will be more useful in future selections.
for(j=f.length-1;j>i;j--){
// Count backwards from the end, reducing student priority as it becomes more likely that they will be needed again
// note that this is only relevant for unassigned students.
icandidates=K(unassignedStudents,f[j]);for(k in icandidates)s=icandidates[k],studentPriority[s]++}if(O(studentPriority),teamsList=initTeamsList.slice(0),teamsList=P(teamsList),teamsList=teamsList.sort(a),"numbers"==p?(teamsList=teamsList.sort(d),O("teams list"),O(m),O(teamsList),h=2):h=1,ucandidates=P(ucandidates),acandidates=P(acandidates),ucandidates=ucandidates.sort(e),ucandidates.length>=n.length)for(
// Best case scenario - assign at random.
O("Best case"),O(ucandidates),unassignedStudents=ucandidates;unassignedStudents.length>0;){
// Get the team(s) with the lowest numbers.
var q=0,u=[];
// Skip the 0th team since otherwise we compare it to itself.
for(j=1;j<m.length;j++)t=m[j],lt=m[q],t.length<lt.length?(q=j,u=[]):t.length==lt.length&&u.push(j);u.push(q);
// Pick a random team from the list of lowest teams.
do randomTeam=Math.floor(Math.random()*u.length);while(randomTeam>=u.length);m[u[randomTeam]].push(unassignedStudents.pop())}else{O(ucandidates.length+acandidates.length<n.length?"Worst case":"Worse case"),O(ucandidates),O(acandidates);
// Get a list of teams with members who already meet this criterion.
var v=[],w=[];// Teams with members who meet this criterion.
for(j in teamsList){t=teamsList[j];var y=!0;// Rendered false if team already has a member who meets this criterion.
for(k in acandidates)c=acandidates[k],ta=m[t],b.inArray(c,ta)!=-1&&(// If student k is already on team t.
y=!1);y?(v.push(t),
// Cover our worst case - not enough people to go around.
teamsPriority[t]+=l):(w.push(t),teamsPriority[t]+=h)}
// Now we have our list of teams split in two, first take the priority teams and assign to them.
for(j in ucandidates)j<v.length?(t=v[j],s=ucandidates[j],m[t].push(s),teamsPriority[t]-=l):(x=j-v.length,t=w[x],s=ucandidates[j],m[t].push(s),teamsPriority[t]-=h)}
// First refresh our assignedStudents and unassignedStudents arrays from teamAssignments.
for(j in m){t=m[j];for(k in unassignedStudents)s=unassignedStudents[k],b.inArray(k,t)!=-1&&(
// Move from unassigned to assigned.
assignedStudents[k]=s,delete unassignedStudents[k],o.push(k))}O(m),O(teamsPriority),O("<br/>")}H()},K=function(a,d){candidates=[];for(c in d){criterion=d[c];
// Get the candidates who that meet the criterion.
for(s in a)L(s,criterion)&&b.inArray(s,candidates)==-1&&candidates.push(s)}return candidates},L=function(c,d){var e=responses[c];// Student responses.
if(e===!1)return!1;var f,g,h;if("any"==d.oper){f=!1;for(a in d.answers)if(g=parseInt(d.answers[a]),b.inArray(g,e)!=-1){f=!0;break}}else if("all"==d.oper){f=!0;for(a in d.answers)if(g=parseInt(d.answers[a]),b.inArray(g,e)==-1){f=!1;break}}else if("none"==d.oper){f=!0;for(a in d.answers)g=parseInt(d.answers[a]),b.inArray(g,e)!=-1&&(f=!1)}if(f&&d.subcriteria)for(i=0;i<d.subcriteria.length&&(h=d.subcriteria[i],f=L(c,h),0!=f);i++);return f},M=function(){G();var a=[];for(b("#unassigned .student").each(function(){rslt=/student-(\d+)/.exec(this.id),a.push(rslt[1])}),a=P(a);a.length>0;){
// Get the team(s) with the lowest numbers.
var c=0,d=[];
// Skip the 0th team since otherwise we compare it to itself.
for(i=1;i<m.length;i++)t=m[i],lt=m[c],t.length<lt.length?(c=i,d=[]):t.length==lt.length&&d.push(i);d.push(c);
// Pick a random team from the list of lowest teams.
do randomTeam=Math.floor(Math.random()*d.length);while(randomTeam>=d.length);m[d[randomTeam]].push(a.pop())}H()},N=function(){
// How this works is, we're going to create an invisible form and submit it
// acutally i don't know if we can do that but we'll try.
G();var a=b('<form action="'+window.location+'" method="POST"></form>');for(i=0;i<n.length;i++){var c=n[i],d=m[i],e=b('<input type="hidden" name="teamnames['+i+']" value="'+c+'" />');a.append(e);var f=b('<input type="hidden" name="teams['+i+']" value="'+d.join(",")+'" />');a.append(f)}var g=b('<input type="hidden" name="action" value="create-groups" />'),h=b('<input type="hidden" name="groupingName" value="'+b("#groupingName").val()+'" />'),j=b('<input type="hidden" name="groupingID" value="'+b("#groupingSelect").val()+'" />'),k=b('<input type="hidden" name="inheritGroupingName" value="'+(b("#inheritGroupingName").is(":checked")?1:0)+'" />'),l=b('<input type="hidden" name="nogrouping" value="'+(b("#nogrouping").is(":checked")?1:0)+'" />');a.append(g),a.append(h),a.append(j),a.append(k),a.append(l),b("#createGroupsForm").append(a),a.submit()},O=function(a){},P=function(a){
// Much more random than sort().
var b=[],c=a.slice(0);for(i=c.length;i>0;i--){var d=Math.floor(Math.random()*i);b.push(c[d]),c.splice(d,1)}return b},Q=function(){b("#addnewcriterion").on("click",E),b("#buildteams").on("click",J),b("#resetteams").on("click",B),b("#assignrandomly").on("click",M),b("#creategroups").on("click",N),b("#predicate").delegate(".addsubcriterion","click",function(a){F(a.target)})};return{init:function(){e.get_strings([{key:"any",component:"mod_teambuilder"},{key:"all",component:"mod_teambuilder"},{key:"none",component:"mod_teambuilder"},{key:"or",component:"mod_teambuilder"},{key:"and",component:"mod_teambuilder"},{key:"addnewsubcriterion",component:"mod_teambuilder"},{key:"criterionquestion",component:"mod_teambuilder"},{key:"criterionsubquestion",component:"mod_teambuilder"}]).done(function(a){y(a),z(),Q()})}}});